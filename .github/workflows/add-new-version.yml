name: Add New API Version

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: 'New version to add (e.g., v3, v4)'
        required: true
        type: string
      status:
        description: 'Initial version status'
        required: true
        type: choice
        options:
          - planned
          - alpha
          - beta
        default: 'planned'
      migration_guide_url:
        description: 'Migration guide URL (optional)'
        required: false
        type: string
        default: 'https://docs.iqq.com/api/migration'
      package_branch:
        description: 'Source branch for package service (default: main)'
        required: false
        type: string
        default: 'main'
      lender_branch:
        description: 'Source branch for lender service (default: main)'
        required: false
        type: string
        default: 'main'
      product_branch:
        description: 'Source branch for product service (default: main)'
        required: false
        type: string
        default: 'main'
      document_branch:
        description: 'Source branch for document service (default: main)'
        required: false
        type: string
        default: 'main'
      infrastructure_branch:
        description: 'Source branch for infrastructure (default: main)'
        required: false
        type: string
        default: 'main'

env:
  AWS_REGION: us-east-1
  GITHUB_ORG: rgcleanslage

concurrency:
  group: add-version-${{ github.event.inputs.new_version }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write

jobs:
  validate-version:
    name: Validate New Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      previous-version: ${{ steps.validate.outputs.previous_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate version format
        id: validate
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.new_version }}"
          if ! [[ "$VERSION" =~ ^v[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"; exit 1
          fi
          if gh release view "api-${VERSION}" --json tagName &>/dev/null; then
            echo "âŒ Version $VERSION already exists as a GitHub Release"; exit 1
          fi
          CURRENT_VERSION=$(gh release list --json tagName,body --limit 100 | \
            jq -r '[.[] | select(.tagName | startswith("api-")) |
              {tag: .tagName, version: (.tagName | ltrimstr("api-")), body: .body} |
              select(.body | contains("\"status\":\"stable\"") or contains("\"status\": \"stable\""))] |
              sort_by(.version) | last | .version // "v1"')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "previous_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version $VERSION validated (previous: $CURRENT_VERSION)"

  create-github-release:
    name: Create GitHub Release
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Create release with version metadata
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PREV_VERSION="${{ needs.validate-version.outputs.previous-version }}"
          STATUS="${{ github.event.inputs.status }}"
          MIGRATION_URL="${{ github.event.inputs.migration_guide_url }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          RELEASE_BODY=$(cat <<EOF
          ## API Version ${VERSION}

          **Status**: ${STATUS}
          **Previous Version**: ${PREV_VERSION}
          **Created**: ${TIMESTAMP}
          **Triggered by**: ${{ github.actor }}

          ### Version Metadata
          \`\`\`json
          {
            "version": "${VERSION}",
            "status": "${STATUS}",
            "sunsetDate": null,
            "migrationGuide": "${MIGRATION_URL}/${PREV_VERSION}-to-${VERSION}",
            "lambdaAlias": "${VERSION}",
            "releaseDate": "${TIMESTAMP}",
            "lastDeployed": null,
            "previousVersion": "${PREV_VERSION}"
          }
          \`\`\`

          ### Checklist
          - [ ] Infrastructure deployed
          - [ ] Services deployed
          - [ ] Endpoints tested
          - [ ] Migration guide updated
          EOF
          )
          gh release create "api-${VERSION}" \
            --title "API Version ${VERSION}" \
            --notes "$RELEASE_BODY" \
            --prerelease
          echo "âœ… GitHub Release created: api-${VERSION}"

  create-migration-guide:
    name: Create Migration Guide
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4
      - name: Generate migration guide
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PREV_VERSION="${{ needs.validate-version.outputs.previous-version }}"
          DATE=$(date +"%B %d, %Y")
          mkdir -p docs/api/migrations
          cat > docs/api/migrations/MIGRATION_${PREV_VERSION}_TO_${VERSION}.md << 'GUIDE_EOF'
          # Migration Guide: PREV_VER to NEW_VER
          **Date**: DATE_PLACEHOLDER | **Status**: Draft
          ## Overview
          This guide helps you migrate from API version PREV_VER to NEW_VER.
          ## Breaking Changes
          > Update this section with any breaking changes between PREV_VER and NEW_VER
          ## Migration Steps
          1. Update your API endpoint URLs from PREV_VER to NEW_VER
          2. Update request/response handling for any breaking changes
          3. Test in development environment
          4. Verify version headers
          5. Deploy to production
          ## Rollback Plan
          If you encounter issues, revert your endpoint URLs back to PREV_VER.
          ---
          **Last Updated**: DATE_PLACEHOLDER
          GUIDE_EOF
          sed -i "s/NEW_VER/${VERSION}/g" docs/api/migrations/MIGRATION_${PREV_VERSION}_TO_${VERSION}.md
          sed -i "s/PREV_VER/${PREV_VERSION}/g" docs/api/migrations/MIGRATION_${PREV_VERSION}_TO_${VERSION}.md
          sed -i "s/DATE_PLACEHOLDER/${DATE}/g" docs/api/migrations/MIGRATION_${PREV_VERSION}_TO_${VERSION}.md
      - name: Upload migration guide
        uses: actions/upload-artifact@v4
        with:
          name: migration-guide
          path: docs/api/migrations/

  deploy-infrastructure:
    name: Deploy Infrastructure with AWS CLI
    needs: [validate-version, create-github-release]
    runs-on: ubuntu-latest
    outputs:
      stage-url: ${{ steps.create-stage.outputs.stage_url }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Get API Gateway ID
        id: get-api
        run: |
          API_ID=$(aws apigateway get-rest-apis \
            --query 'items[?name==`iqq-api-dev`].id' --output text)
          if [ -z "$API_ID" ]; then echo "âŒ API Gateway not found"; exit 1; fi
          echo "api_id=$API_ID" >> $GITHUB_OUTPUT
      - name: Get deployment ID
        id: get-deployment
        run: |
          DEPLOYMENT_ID=$(aws apigateway get-deployments \
            --rest-api-id "${{ steps.get-api.outputs.api_id }}" \
            --query 'items[0].id' --output text)
          if [ -z "$DEPLOYMENT_ID" ]; then echo "âŒ No deployments found"; exit 1; fi
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
      - name: Create API Gateway stage
        id: create-stage
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          API_ID="${{ steps.get-api.outputs.api_id }}"
          DEPLOYMENT_ID="${{ steps.get-deployment.outputs.deployment_id }}"
          if aws apigateway get-stage --rest-api-id "$API_ID" --stage-name "$VERSION" 2>/dev/null; then
            echo "â„¹ï¸  Stage $VERSION already exists"
          else
            aws apigateway create-stage \
              --rest-api-id "$API_ID" --stage-name "$VERSION" \
              --deployment-id "$DEPLOYMENT_ID" \
              --variables lambdaAlias="$VERSION" \
              --tags Name="iqq-api-${VERSION}-dev",Stage="$VERSION",Environment="dev"
            echo "âœ… Stage $VERSION created"
          fi
          STAGE_URL="https://${API_ID}.execute-api.${AWS_REGION}.amazonaws.com/${VERSION}"
          echo "stage_url=$STAGE_URL" >> $GITHUB_OUTPUT
      - name: Add Lambda permissions
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          API_ID="${{ steps.get-api.outputs.api_id }}"
          for SERVICE in package lender product document; do
            FUNCTION_NAME="iqq-${SERVICE}-service-dev"
            STATEMENT_ID="AllowAPIGatewayInvoke${VERSION^^}"
            aws lambda remove-permission --function-name "$FUNCTION_NAME" \
              --statement-id "$STATEMENT_ID" --qualifier "$VERSION" 2>/dev/null || true
            aws lambda add-permission --function-name "$FUNCTION_NAME" \
              --statement-id "$STATEMENT_ID" --action lambda:InvokeFunction \
              --principal apigateway.amazonaws.com \
              --source-arn "arn:aws:execute-api:${AWS_REGION}:*:${API_ID}/${VERSION}/GET/${SERVICE}" \
              --qualifier "$VERSION" 2>/dev/null || echo "âš ï¸  Permission issue for $FUNCTION_NAME"
          done
          echo "âœ… Lambda permissions configured"

  create-release-branches:
    name: Create Release Branches
    needs: validate-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: [iqq-package-service, iqq-lender-service, iqq-product-service, iqq-document-service, iqq-infrastructure]
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_ORG }}/${{ matrix.repo }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
      - name: Create release branch
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          BRANCH_NAME="release/$VERSION"
          REPO="${{ matrix.repo }}"
          case "$REPO" in
            iqq-package-service)  SOURCE_BRANCH="${{ github.event.inputs.package_branch }}" ;;
            iqq-lender-service)   SOURCE_BRANCH="${{ github.event.inputs.lender_branch }}" ;;
            iqq-product-service)  SOURCE_BRANCH="${{ github.event.inputs.product_branch }}" ;;
            iqq-document-service) SOURCE_BRANCH="${{ github.event.inputs.document_branch }}" ;;
            iqq-infrastructure)   SOURCE_BRANCH="${{ github.event.inputs.infrastructure_branch }}" ;;
            *)                    SOURCE_BRANCH="main" ;;
          esac
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "â„¹ï¸  Branch $BRANCH_NAME already exists"; exit 0
          fi
          git fetch origin "$SOURCE_BRANCH"
          git checkout "$SOURCE_BRANCH" 2>/dev/null || git checkout -b "$SOURCE_BRANCH" "origin/$SOURCE_BRANCH"
          git pull origin "$SOURCE_BRANCH"
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"
          echo "âœ… Created $BRANCH_NAME in $REPO from $SOURCE_BRANCH"

  notify-completion:
    name: Notify Completion
    needs: [validate-version, create-github-release, deploy-infrastructure, create-release-branches, create-migration-guide]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Add New API Version Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Version: $VERSION | Status: ${{ github.event.inputs.status }}"
          echo "âœ… GitHub Release created: api-$VERSION"
          echo "âœ… Infrastructure deployed: ${{ needs.deploy-infrastructure.outputs.stage-url }}"
          echo "âœ… Release branches created"
          echo "âœ… Migration guide generated"
