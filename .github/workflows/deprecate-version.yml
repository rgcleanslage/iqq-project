name: Deprecate API Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deprecate (e.g., v1, v2)'
        required: true
        type: string
      sunset_date:
        description: 'Sunset date (YYYY-MM-DD)'
        required: true
        type: string
      migration_guide_url:
        description: 'Migration guide URL'
        required: true
        type: string
        default: 'https://docs.iqq.com/api/migration/v1-to-v2'

env:
  AWS_REGION: us-east-1
  GITHUB_ORG: rgcleanslage

concurrency:
  group: deprecate-${{ github.event.inputs.version }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write

jobs:
  validate-deprecation:
    name: Validate Deprecation Request
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.validate.outputs.current_version }}
      sunset-timestamp: ${{ steps.validate.outputs.sunset_timestamp }}
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4

      - name: Validate deprecation from releases
        id: validate
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SUNSET_DATE="${{ github.event.inputs.sunset_date }}"

          echo "ğŸ” Validating deprecation request for $VERSION"

          # Check if release exists
          RELEASE_BODY=$(gh release view "api-${VERSION}" --json body --jq '.body' 2>/dev/null)
          if [ -z "$RELEASE_BODY" ]; then
            echo "âŒ Version $VERSION not found as a GitHub Release"
            exit 1
          fi

          # Get current status
          CURRENT_STATUS=$(echo "$RELEASE_BODY" | sed -n '/```json/,/```/p' | sed '1d;$d' | jq -r '.status')

          # Find the current stable version from all releases
          CURRENT_VERSION=$(gh release list --json tagName,body --limit 100 | \
            jq -r '[.[] | select(.tagName | startswith("api-")) |
              {tag: .tagName, version: (.tagName | ltrimstr("api-")), body: .body} |
              select(.body | contains("\"status\":\"stable\"") or contains("\"status\": \"stable\""))] |
              sort_by(.version) | last | .version // "v1"')

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Cannot deprecate current stable version
          if [ "$VERSION" == "$CURRENT_VERSION" ]; then
            echo "âŒ Cannot deprecate current stable version $VERSION"
            echo "   Please promote a new version to stable first"
            exit 1
          fi

          # Validate sunset date format
          if ! date -d "$SUNSET_DATE" >/dev/null 2>&1; then
            echo "âŒ Invalid sunset date format: $SUNSET_DATE"
            exit 1
          fi

          SUNSET_TIMESTAMP=$(date -d "$SUNSET_DATE 23:59:59 UTC" -u +%Y-%m-%dT%H:%M:%SZ)
          CURRENT_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          if [[ "$SUNSET_TIMESTAMP" < "$CURRENT_TIMESTAMP" ]]; then
            echo "âŒ Sunset date must be in the future"
            exit 1
          fi

          echo "sunset_timestamp=$SUNSET_TIMESTAMP" >> $GITHUB_OUTPUT

          DAYS_UNTIL_SUNSET=$(( ($(date -d "$SUNSET_DATE" +%s) - $(date +%s)) / 86400 ))
          if [ $DAYS_UNTIL_SUNSET -lt 90 ]; then
            echo "âš ï¸  Warning: Less than 90 days until sunset ($DAYS_UNTIL_SUNSET days)"
          fi

          echo "âœ… Deprecation request validated"
          echo "   Version: $VERSION (status: $CURRENT_STATUS)"
          echo "   Current stable: $CURRENT_VERSION"
          echo "   Sunset date: $SUNSET_TIMESTAMP"

  update-release-metadata:
    name: Update Release to Deprecated
    needs: validate-deprecation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4

      - name: Update GitHub Release metadata
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SUNSET_TIMESTAMP="${{ needs.validate-deprecation.outputs.sunset-timestamp }}"
          MIGRATION_URL="${{ github.event.inputs.migration_guide_url }}"

          echo "ğŸ“ Updating release metadata for api-${VERSION}..."

          # Get current release body
          RELEASE_BODY=$(gh release view "api-${VERSION}" --json body --jq '.body')

          # Update status, sunsetDate, and migrationGuide in the JSON block
          UPDATED_BODY=$(echo "$RELEASE_BODY" | \
            sed "s/\"status\": *\"[^\"]*\"/\"status\": \"deprecated\"/" | \
            sed "s/\"sunsetDate\": *null/\"sunsetDate\": \"${SUNSET_TIMESTAMP}\"/" | \
            sed "s|\"migrationGuide\": *\"[^\"]*\"|\"migrationGuide\": \"${MIGRATION_URL}\"|")

          # Also update the human-readable status line
          UPDATED_BODY=$(echo "$UPDATED_BODY" | \
            sed "s/\*\*Status\*\*: *[a-zA-Z]*/\*\*Status\*\*: deprecated/")

          gh release edit "api-${VERSION}" --notes "$UPDATED_BODY"

          echo "âœ… Release api-${VERSION} updated to deprecated"

  update-stage-variables:
    name: Update API Gateway Stage Variables
    needs: [validate-deprecation, update-release-metadata]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update stage variables
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SUNSET_TIMESTAMP="${{ needs.validate-deprecation.outputs.sunset-timestamp }}"
          MIGRATION_URL="${{ github.event.inputs.migration_guide_url }}"
          CURRENT_VERSION="${{ needs.validate-deprecation.outputs.current-version }}"
          
          API_ID=$(aws apigateway get-rest-apis \
            --query 'items[?name==`iqq-api-dev`].id' --output text)
          
          if [ -z "$API_ID" ]; then
            echo "âŒ API Gateway not found"
            exit 1
          fi
          
          echo "ğŸ“ Updating stage variables for ${VERSION}..."
          
          # Check if stage exists
          if ! aws apigateway get-stage \
            --rest-api-id "$API_ID" \
            --stage-name "$VERSION" \
            > /dev/null 2>&1; then
            echo "âš ï¸  Stage ${VERSION} not found, skipping"
            exit 0
          fi
          
          # Update stage variables
          aws apigateway update-stage \
            --rest-api-id "$API_ID" \
            --stage-name "$VERSION" \
            --patch-operations \
              op=replace,path=/variables/versionStatus,value=deprecated \
              op=replace,path=/variables/versionSunsetDate,value="${SUNSET_TIMESTAMP}" \
              op=replace,path=/variables/versionMigrationGuide,value="${MIGRATION_URL}" \
              op=replace,path=/variables/versionCurrent,value="${CURRENT_VERSION}"
          
          echo "âœ… Updated stage variables for ${VERSION}"
          echo "   versionStatus=deprecated"
          echo "   versionSunsetDate=${SUNSET_TIMESTAMP}"
          echo "   versionMigrationGuide=${MIGRATION_URL}"
          echo "   versionCurrent=${CURRENT_VERSION}"

  verify-deprecation-headers:
    name: Verify Deprecation Headers
    needs: update-stage-variables
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Wait for stage variable propagation
        run: |
          echo "â³ Waiting 5 seconds for stage variables to propagate..."
          sleep 5

      - name: Get OAuth token
        id: auth
        run: |
          USER_POOL_ID=$(aws cognito-idp list-user-pools --max-results 10 \
            --query 'UserPools[?Name==`iqq-dev-user-pool`].Id' --output text)

          DOMAIN=$(aws cognito-idp describe-user-pool --user-pool-id "$USER_POOL_ID" \
            --query 'UserPool.Domain' --output text 2>/dev/null || echo "iqq-dev-ib9i1hvt")

          CLIENT_ID=$(aws secretsmanager get-secret-value \
            --secret-id "iqq-dev-cognito-client-default" \
            --query 'SecretString' --output text | jq -r '.client_id')

          CLIENT_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "iqq-dev-cognito-client-default" \
            --query 'SecretString' --output text | jq -r '.client_secret')

          API_KEY=$(aws secretsmanager get-secret-value \
            --secret-id "iqq-dev-api-key-default" \
            --query 'SecretString' --output text | jq -r '.api_key')

          TOKEN=$(curl -s -X POST "https://${DOMAIN}.auth.us-east-1.amazoncognito.com/oauth2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -u "${CLIENT_ID}:${CLIENT_SECRET}" \
            -d "grant_type=client_credentials" | jq -r '.access_token')

          echo "::add-mask::$TOKEN"
          echo "::add-mask::$API_KEY"
          echo "::add-mask::$CLIENT_SECRET"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "api_key=$API_KEY" >> $GITHUB_OUTPUT

      - name: Test deprecation headers
        env:
          TOKEN: ${{ steps.auth.outputs.token }}
          API_KEY: ${{ steps.auth.outputs.api_key }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          echo "ğŸ§ª Testing deprecation headers for version $VERSION"

          for SERVICE in package lender product document; do
            echo ""
            echo "Testing $SERVICE service..."

            RESPONSE=$(curl -s -i \
              -H "Authorization: Bearer $TOKEN" \
              -H "x-api-key: $API_KEY" \
              "https://r8ukhidr1m.execute-api.us-east-1.amazonaws.com/$VERSION/$SERVICE")

            API_DEPRECATED=$(echo "$RESPONSE" | grep -i "^x-api-deprecated:" | cut -d' ' -f2 | tr -d '\r')
            API_SUNSET=$(echo "$RESPONSE" | grep -i "^x-api-sunset-date:" | cut -d' ' -f2 | tr -d '\r')

            if [ "$API_DEPRECATED" == "true" ]; then
              echo "  âœ… X-API-Deprecated: true"
            else
              echo "  âŒ X-API-Deprecated header incorrect: $API_DEPRECATED"
              exit 1
            fi

            if [ ! -z "$API_SUNSET" ] && [ "$API_SUNSET" != "null" ]; then
              echo "  âœ… X-API-Sunset-Date: $API_SUNSET"
            else
              echo "  âŒ X-API-Sunset-Date header missing or null"
              exit 1
            fi
          done

          echo ""
          echo "âœ… Deprecation headers verified"

  notify-completion:
    name: Notify Completion
    needs: [validate-deprecation, verify-deprecation-headers]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deprecation summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SUNSET_DATE="${{ github.event.inputs.sunset_date }}"
          CURRENT_VERSION="${{ needs.validate-deprecation.outputs.current-version }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  API Version Deprecation Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Deprecated Version: $VERSION"
          echo "Current Stable: $CURRENT_VERSION"
          echo "Sunset Date: $SUNSET_DATE"
          echo "Migration Guide: ${{ github.event.inputs.migration_guide_url }}"
          echo ""
          echo "âœ… GitHub Release metadata updated"
          echo "âœ… API Gateway stage variables updated"
          echo "âœ… Deprecation headers verified"
          echo ""
          echo "ğŸ“¢ Next Steps:"
          echo "   1. Notify API consumers about deprecation"
          echo "   2. Monitor usage of deprecated version"
          echo "   3. Plan sunset workflow for $SUNSET_DATE"
          echo ""
