name: 5. Sunset API Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sunset (e.g., v1, v2)'
        required: true
        type: string
      confirm:
        description: 'Type "CONFIRM" to proceed with sunset'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  GITHUB_ORG: rgcleanslage

concurrency:
  group: sunset-${{ github.event.inputs.version }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write

jobs:
  validate-sunset:
    name: Validate Sunset Request
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.validate.outputs.current_version }}
      version-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4

      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "CONFIRM" ]; then
            echo "âŒ Sunset not confirmed. Please type 'CONFIRM' to proceed."
            exit 1
          fi

      - name: Validate sunset request from releases
        id: validate
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"

          echo "ðŸ” Validating sunset request for $VERSION"

          # Check if release exists
          RELEASE_BODY=$(gh release view "api-${VERSION}" --json body --jq '.body' 2>/dev/null)
          if [ -z "$RELEASE_BODY" ]; then
            echo "âŒ Version $VERSION not found as a GitHub Release"
            exit 1
          fi

          # Extract status from release metadata
          STATUS=$(echo "$RELEASE_BODY" | sed -n '/```json/,/```/p' | sed '1d;$d' | jq -r '.status')
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          # Find current stable version
          CURRENT_VERSION=$(gh release list --json tagName,body --limit 100 | \
            jq -r '[.[] | select(.tagName | startswith("api-")) |
              {tag: .tagName, version: (.tagName | ltrimstr("api-")), body: .body} |
              select(.body | contains("\"status\":\"stable\"") or contains("\"status\": \"stable\""))] |
              sort_by(.version) | last | .version // "v1"')

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          if [ "$VERSION" == "$CURRENT_VERSION" ]; then
            echo "âŒ Cannot sunset current stable version $VERSION"
            exit 1
          fi

          if [ "$STATUS" != "deprecated" ]; then
            echo "âš ï¸  Warning: Version $VERSION is not deprecated (status: $STATUS)"
            echo "   Recommended: Deprecate version before sunset"
          fi

          # Check if sunset date has passed
          SUNSET_DATE=$(echo "$RELEASE_BODY" | sed -n '/```json/,/```/p' | sed '1d;$d' | jq -r '.sunsetDate')
          if [ "$SUNSET_DATE" != "null" ] && [ "$SUNSET_DATE" != "" ]; then
            CURRENT_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            if [[ "$SUNSET_DATE" > "$CURRENT_TIMESTAMP" ]]; then
              echo "âš ï¸  Warning: Sunset date has not passed yet ($SUNSET_DATE)"
            fi
          fi

          echo "âœ… Sunset request validated"
          echo "   Version: $VERSION (status: $STATUS)"
          echo "   Current stable: $CURRENT_VERSION"

  check-usage:
    name: Check Version Usage
    needs: validate-sunset
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check CloudWatch metrics
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ“Š Checking usage metrics for version $VERSION"
          echo "âš ï¸  Manual verification recommended:"
          echo "   1. Check CloudWatch metrics for /$VERSION/* requests"
          echo "   2. Review API Gateway access logs"
          echo "   3. Confirm with API consumers"
          echo "   Proceeding with sunset..."

  remove-api-gateway-stage:
    name: Remove API Gateway Stage
    needs: [validate-sunset, check-usage]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get API Gateway ID
        id: get-api
        run: |
          API_ID=$(aws apigateway get-rest-apis \
            --query 'items[?name==`iqq-api-dev`].id' --output text)

          if [ -z "$API_ID" ]; then
            echo "âŒ API Gateway not found"
            exit 1
          fi

          echo "api_id=$API_ID" >> $GITHUB_OUTPUT

      - name: Remove API Gateway stage
        run: |
          VERSION="${{ github.event.inputs.version }}"
          API_ID="${{ steps.get-api.outputs.api_id }}"

          if ! aws apigateway get-stage --rest-api-id "$API_ID" --stage-name "$VERSION" 2>/dev/null; then
            echo "â„¹ï¸  Stage $VERSION does not exist"
            exit 0
          fi

          aws apigateway delete-stage --rest-api-id "$API_ID" --stage-name "$VERSION"
          echo "âœ… API Gateway stage $VERSION removed"

      - name: Verify stage removal
        run: |
          VERSION="${{ github.event.inputs.version }}"
          API_ID="${{ steps.get-api.outputs.api_id }}"

          if aws apigateway get-stage --rest-api-id "$API_ID" --stage-name "$VERSION" 2>/dev/null; then
            echo "âŒ Stage $VERSION still exists"
            exit 1
          fi
          echo "âœ… Stage removal verified"

  cleanup-lambda-aliases:
    name: Cleanup Lambda Aliases
    needs: remove-api-gateway-stage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [package, lender, product, document]
      fail-fast: false
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Remove Lambda alias
        run: |
          VERSION="${{ github.event.inputs.version }}"
          FUNCTION_NAME="iqq-${{ matrix.service }}-service-dev"

          if ! aws lambda get-alias --function-name "$FUNCTION_NAME" --name "$VERSION" 2>/dev/null; then
            echo "â„¹ï¸  Alias $VERSION does not exist for $FUNCTION_NAME"
            exit 0
          fi

          aws lambda delete-alias --function-name "$FUNCTION_NAME" --name "$VERSION"
          echo "âœ… Lambda alias $VERSION removed from $FUNCTION_NAME"

  update-release-metadata:
    name: Update Release to Sunset
    needs: cleanup-lambda-aliases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4

      - name: Update GitHub Release metadata
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          RELEASE_BODY=$(gh release view "api-${VERSION}" --json body --jq '.body')

          # Update status to sunset in JSON metadata
          UPDATED_BODY=$(echo "$RELEASE_BODY" | \
            sed "s/\"status\": *\"[^\"]*\"/\"status\": \"sunset\"/" | \
            sed "s/\*\*Status\*\*: *[a-zA-Z]*/\*\*Status\*\*: sunset/")

          gh release edit "api-${VERSION}" --notes "$UPDATED_BODY"

          echo "âœ… Release api-${VERSION} updated to sunset"

  archive-documentation:
    name: Archive Version Documentation
    needs: update-release-metadata
    runs-on: ubuntu-latest
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Archive version documentation
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ARCHIVE_DIR="docs/api/archive/$VERSION"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          mkdir -p "$ARCHIVE_DIR"

          cat > "$ARCHIVE_DIR/README.md" << EOF
          # API Version $VERSION - Archived

          **Status**: Sunset
          **Sunset Date**: $TIMESTAMP
          **Current Version**: ${{ needs.validate-sunset.outputs.current-version }}

          This version has been sunset and is no longer available.
          Please migrate to version ${{ needs.validate-sunset.outputs.current-version }}.

          ---
          Archived: $TIMESTAMP
          EOF

          echo "âœ… Archive documentation created"

      - name: Commit archive
        run: |
          VERSION="${{ github.event.inputs.version }}"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/api/archive/
          git commit -m "docs: archive version $VERSION documentation"
          git push

          echo "âœ… Archive committed"

  notify-completion:
    name: Notify Completion
    needs: [validate-sunset, archive-documentation]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Sunset summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          CURRENT_VERSION="${{ needs.validate-sunset.outputs.current-version }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ… API Version Sunset Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Sunset Version: $VERSION"
          echo "Current Stable: $CURRENT_VERSION"
          echo ""
          echo "âœ… API Gateway stage removed"
          echo "âœ… Lambda aliases cleaned up"
          echo "âœ… GitHub Release metadata updated"
          echo "âœ… Documentation archived"
          echo ""
          echo "âš ï¸  Version $VERSION is no longer accessible"
          echo ""
