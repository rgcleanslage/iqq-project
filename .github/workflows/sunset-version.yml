name: Sunset API Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sunset (v1, v2)'
        required: true
        type: choice
        options:
          - v1
          - v2
      confirm:
        description: 'Type "CONFIRM" to proceed with sunset'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  GITHUB_ORG: rgcleanslage

jobs:
  validate-sunset:
    name: Validate Sunset Request
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.validate.outputs.current_version }}
      version-status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4
      
      - name: Validate confirmation
        run: |
          CONFIRM="${{ github.event.inputs.confirm }}"
          
          if [ "$CONFIRM" != "CONFIRM" ]; then
            echo "âŒ Sunset not confirmed"
            echo "   Please type 'CONFIRM' to proceed"
            exit 1
          fi
          
          echo "âœ… Sunset confirmed"
      
      - name: Validate sunset request
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          echo "ðŸ” Validating sunset request for $VERSION"
          
          # Check if version exists
          if ! jq -e ".versions[\"$VERSION\"]" config/version-policy.json > /dev/null; then
            echo "âŒ Version $VERSION not found in configuration"
            exit 1
          fi
          
          # Get version status
          STATUS=$(jq -r ".versions[\"$VERSION\"].status" config/version-policy.json)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          # Get current version
          CURRENT_VERSION=$(jq -r '.currentVersion' config/version-policy.json)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Cannot sunset current version
          if [ "$VERSION" == "$CURRENT_VERSION" ]; then
            echo "âŒ Cannot sunset current version $VERSION"
            exit 1
          fi
          
          # Version should be deprecated before sunset
          if [ "$STATUS" != "deprecated" ]; then
            echo "âš ï¸  Warning: Version $VERSION is not deprecated (status: $STATUS)"
            echo "   Recommended: Deprecate version before sunset"
          fi
          
          # Check if sunset date has passed
          SUNSET_DATE=$(jq -r ".versions[\"$VERSION\"].sunsetDate" config/version-policy.json)
          if [ "$SUNSET_DATE" != "null" ]; then
            CURRENT_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            if [[ "$SUNSET_DATE" > "$CURRENT_TIMESTAMP" ]]; then
              echo "âš ï¸  Warning: Sunset date has not passed yet"
              echo "   Sunset date: $SUNSET_DATE"
              echo "   Current time: $CURRENT_TIMESTAMP"
            fi
          fi
          
          echo "âœ… Sunset request validated"
          echo "   Version: $VERSION"
          echo "   Status: $STATUS"
          echo "   Current version: $CURRENT_VERSION"

  check-usage:
    name: Check Version Usage
    needs: validate-sunset
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check CloudWatch metrics
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          echo "ðŸ“Š Checking usage metrics for version $VERSION"
          
          # Get API Gateway metrics for the last 7 days
          END_TIME=$(date -u +%Y-%m-%dT%H:%M:%S)
          START_TIME=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%S)
          
          echo "   Period: $START_TIME to $END_TIME"
          
          # Note: This is a simplified check
          # In production, you would query CloudWatch metrics for actual usage
          
          echo "âš ï¸  Manual verification recommended:"
          echo "   1. Check CloudWatch metrics for /$VERSION/* requests"
          echo "   2. Review API Gateway access logs"
          echo "   3. Confirm with API consumers"
          echo ""
          echo "   Proceeding with sunset..."

  remove-api-gateway-stage:
    name: Remove API Gateway Stage
    needs: [validate-sunset, check-usage]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_ORG }}/iqq-infrastructure
          token: ${{ secrets.PAT_TOKEN }}
          path: infrastructure
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Remove API Gateway stage
        working-directory: infrastructure
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          terraform init
          
          API_ID=$(terraform output -raw api_gateway_id)
          
          echo "ðŸ—‘ï¸  Removing API Gateway stage: $VERSION"
          
          # Check if stage exists
          if ! aws apigateway get-stage \
            --rest-api-id "$API_ID" \
            --stage-name "$VERSION" 2>/dev/null; then
            echo "â„¹ï¸  Stage $VERSION does not exist"
            exit 0
          fi
          
          # Delete the stage
          aws apigateway delete-stage \
            --rest-api-id "$API_ID" \
            --stage-name "$VERSION"
          
          echo "âœ… API Gateway stage $VERSION removed"
      
      - name: Verify stage removal
        working-directory: infrastructure
        run: |
          VERSION="${{ github.event.inputs.version }}"
          API_ID=$(terraform output -raw api_gateway_id)
          
          # Verify stage is gone
          if aws apigateway get-stage \
            --rest-api-id "$API_ID" \
            --stage-name "$VERSION" 2>/dev/null; then
            echo "âŒ Stage $VERSION still exists"
            exit 1
          fi
          
          echo "âœ… Stage removal verified"

  cleanup-lambda-aliases:
    name: Cleanup Lambda Aliases
    needs: remove-api-gateway-stage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [package, lender, product, document]
      fail-fast: false
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Remove Lambda alias
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SERVICE="${{ matrix.service }}"
          FUNCTION_NAME="iqq-${SERVICE}-service-dev"
          
          echo "ðŸ—‘ï¸  Removing Lambda alias $VERSION from $FUNCTION_NAME"
          
          # Check if alias exists
          if ! aws lambda get-alias \
            --function-name "$FUNCTION_NAME" \
            --name "$VERSION" 2>/dev/null; then
            echo "â„¹ï¸  Alias $VERSION does not exist for $FUNCTION_NAME"
            exit 0
          fi
          
          # Delete the alias
          aws lambda delete-alias \
            --function-name "$FUNCTION_NAME" \
            --name "$VERSION"
          
          echo "âœ… Lambda alias $VERSION removed from $FUNCTION_NAME"
      
      - name: Verify alias removal
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SERVICE="${{ matrix.service }}"
          FUNCTION_NAME="iqq-${SERVICE}-service-dev"
          
          # Verify alias is gone
          if aws lambda get-alias \
            --function-name "$FUNCTION_NAME" \
            --name "$VERSION" 2>/dev/null; then
            echo "âŒ Alias $VERSION still exists for $FUNCTION_NAME"
            exit 1
          fi
          
          echo "âœ… Alias removal verified for $FUNCTION_NAME"

  update-version-policy:
    name: Update Version Policy
    needs: cleanup-lambda-aliases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Update version policy
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          echo "ðŸ“ Updating version policy..."
          
          # Update version status to sunset
          jq --arg version "$VERSION" \
             --arg timestamp "$TIMESTAMP" \
             '.versions[$version].status = "sunset" |
              .versions[$version].sunsetAt = $timestamp' \
             config/version-policy.json > config/version-policy.json.tmp
          
          mv config/version-policy.json.tmp config/version-policy.json
          
          echo "âœ… Version policy updated"
          cat config/version-policy.json | jq ".versions[\"$VERSION\"]"
      
      - name: Commit and push changes
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add config/version-policy.json
          git commit -m "chore: sunset version $VERSION"
          git push
          
          echo "âœ… Changes committed and pushed"

  archive-documentation:
    name: Archive Version Documentation
    needs: update-version-policy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout root repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Create archive directory
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ARCHIVE_DIR="docs/api/archive/$VERSION"
          
          mkdir -p "$ARCHIVE_DIR"
          
          echo "ðŸ“¦ Creating documentation archive for $VERSION"
          echo "   Directory: $ARCHIVE_DIR"
      
      - name: Archive version documentation
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ARCHIVE_DIR="docs/api/archive/$VERSION"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Create archive README
          cat > "$ARCHIVE_DIR/README.md" << EOF
          # API Version $VERSION - Archived
          
          **Status**: Sunset  
          **Sunset Date**: $TIMESTAMP  
          **Current Version**: ${{ needs.validate-sunset.outputs.current-version }}
          
          This version has been sunset and is no longer available.
          
          ## Migration
          
          Please migrate to version ${{ needs.validate-sunset.outputs.current-version }}.
          
          See migration guide: [Migration Guide](../../MIGRATION_V1_TO_V2.md)
          
          ## Historical Information
          
          This directory contains archived documentation for version $VERSION.
          
          ---
          
          Archived: $TIMESTAMP
          EOF
          
          echo "âœ… Archive documentation created"
      
      - name: Commit archive
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/api/archive/
          git commit -m "docs: archive version $VERSION documentation"
          git push
          
          echo "âœ… Archive committed"

  notify-completion:
    name: Notify Completion
    needs: archive-documentation
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Sunset summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          CURRENT_VERSION="${{ needs.validate-sunset.outputs.current-version }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ… API Version Sunset Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Sunset Version: $VERSION"
          echo "Current Version: $CURRENT_VERSION"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "âœ… API Gateway stage removed"
          echo "âœ… Lambda aliases cleaned up"
          echo "âœ… Version policy updated"
          echo "âœ… Documentation archived"
          echo ""
          echo "âš ï¸  Version $VERSION is no longer accessible"
          echo ""
          echo "ðŸ“¢ Post-Sunset Actions:"
          echo "   1. Notify API consumers"
          echo "   2. Update external documentation"
          echo "   3. Monitor for any remaining usage attempts"
          echo "   4. Review and update monitoring dashboards"
          echo ""
